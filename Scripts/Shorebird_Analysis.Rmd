---
title: "shorebirds"
author: "antsypants"
date: "2023-10-03"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Setting up environment

```{r setup, include=FALSE}

#install.packages(egg)
library(egg)
#install.packages(tidyverse)
library(tidyverse)
#install.packages(ggplot2)
library(ggplot2)
#install.packages(PNWColors)
library(PNWColors)
#install.packages("ggh4x)
library(ggh4x) # for free y-axis
#install.packages("RColorBrewer")
library(RColorBrewer)
#install.packages("writexl")
library(writexl)

#get working directory, should be set to root Shorebirds folder!
getwd()

#Load in shorebird data
shorebirds_old <- read.csv("./Data/Shorebird_Data_Full.csv")
shorebirds_new<- read.csv("./Data/FINAL_Shorebird_2011_2025.csv")

# Create the "plots" folder in the root directory, if already present, it ignores command
output_dir <- "plots"
if (!dir.exists(output_dir)) {
  dir.create(output_dir)
  cat("Created 'plots' folder in root directory\n")
} else {
  cat("'plots' folder already exists\n")
}
```

# Data Wrangling

```{r}
#changing the date to proper date format
shorebirds_old$SurveyDate<- as.Date(shorebirds_old$SurveyDate, format = "%d-%b-%y")

#changing the date to proper date format
shorebirds_new$SurveyDate<- as.Date(shorebirds_new$SurveyDate, format = "%Y-%m-%d")

#Gets rid of wrongly entered entry
shorebirds_new<- shorebirds_new%>%
  filter(DataType != "select species")

#Capitalize every single bird name
shorebirds_new$DataType<- str_to_title(shorebirds_new$DataType)

#Capitalize every single bird name
shorebirds_old$DataType<- str_to_title(shorebirds_old$DataType)

#Curiosity check: Seeing all the unique bird names in old data set
unique_values_old<- shorebirds_old%>% distinct(DataType)

#Curiosity check: Seeing all the unique bird names in new data set
unique_vales_new<- shorebirds_new%>% distinct(DataType)

#Expand new dataset to include zeroes
allshore_new<- shorebirds_new%>% expand(ZoneClass, SurveyDate, DataType)

#Expanding old dataset to include zeroes
allshore_old <- shorebirds_old %>% expand(ZoneClass, SurveyDate, DataType)


# cleaning up
shorebirds_clean_old <- shorebirds_old %>%
  dplyr::right_join(allshore_old) %>%
  # Boulders & Rocky Outcrop to Zone III
  mutate(Zone = case_when(
    ZoneClass == 'I' ~ 'Zone I',
    ZoneClass == 'II' ~ 'Zone II',
    ZoneClass == 'III' ~ 'Zone III',
    ZoneClass == 'Boulders' ~ 'Zone III',
    ZoneClass == 'Rocky Outcrop' ~ 'Zone III', 
    TRUE ~ 'X')) %>% 
  replace(is.na(.), 0)%>%
  select(-X, -X.1)%>%
  filter(SurveyDate<= as.Date("2010-12-31"))

# cleaning up
shorebirds_clean_new <- shorebirds_new %>%
  dplyr::right_join(allshore_new) %>%
  # Boulders & Rocky Outcrop to Zone III
  mutate(Zone = case_when(
    ZoneClass == 'I' ~ 'Zone I',
    ZoneClass == 'II' ~ 'Zone II',
    ZoneClass == 'III' ~ 'Zone III',
    ZoneClass == 'III Boulders' ~ 'Zone III',
    ZoneClass == 'III Rocky Outcrop' ~ 'Zone III', 
    TRUE ~ 'X')) %>% 
  replace(is.na(.), 0)%>%
  select(-X)

# Joining old shorebird dataset and new shorebird dataset
shorebirds_processed<- shorebirds_clean_old%>%
  full_join(shorebirds_clean_new)%>%
  mutate(
    Month= month(SurveyDate),
    Year= year(SurveyDate)
  )%>%
  select(SurveyDate, Year, Month, ZoneClass, Zone, DataType, DataCount)%>%
  arrange(SurveyDate, Zone)

#save PROCESSED/CLEAN DATASET TO DATA FOLDER!!
write.csv(shorebirds_processed, file = "./Data/Shorebirds_processed_1990_2025.csv")

#Removing intermediary datasets
rm(shorebirds_clean_new, shorebirds_clean_old, allshore_new, allshore_old, unique_vales_new, unique_values_old,shorebirds_new, shorebirds_old)
```

# Setting up dataset for analysis

```{r}
# total surveys (monthly for all years) + shorebird means per survey
shorebirds_surveymeans <- shorebirds_processed %>%
  select(DataType, DataCount, SurveyDate, Year, Month, Zone) %>% 
  group_by(Month) %>% 
  mutate(surveynumber_monthly = n_distinct(SurveyDate, Month),
         mean_per_survey_monthly=(DataCount/surveynumber_monthly)) %>% 
  ungroup() %>% 
  group_by(Year) %>% 
  mutate(surveynumber_yearly = n_distinct(SurveyDate, Year),
         mean_per_survey_yearly=(DataCount/surveynumber_yearly)) %>% 
  ungroup()

# fixed dataset
shorebirds_fixed <- shorebirds_processed %>% 
  dplyr::right_join(shorebirds_surveymeans)

#Remove intermediary dataset
rm(shorebirds_surveymeans)
```

# Summary statistics

```{r}
# for Appendix

#Yearly Survey Count
surveycounts <- shorebirds_fixed %>% 
  group_by(Year) %>% 
  mutate(surveynumber_yearly = n_distinct(SurveyDate)) %>% 
  summarize(surveytotal=surveynumber_yearly) %>% 
  distinct(Year, surveytotal, .keep_all = TRUE)

#Bird count sum by year
bird_counts <- shorebirds_fixed %>%
  group_by(DataType, Year) %>% 
  mutate(DataType = case_when(
    DataType == 'People' ~ 'People',
    DataType == 'Dogs On Leash' ~ 'Dogs On Leash',
    TRUE ~ 'Birds')) %>% 
  filter(DataType != "Dogs On Leash",
         DataType != "People") %>%
  ungroup() %>% 
  group_by(Year) %>% 
  summarize(birdtotal = sum(DataCount))

#People count sum by year (including dogs)
people_counts <- shorebirds_fixed %>%
  group_by(DataType, Year) %>% 
  mutate(DataType = case_when(
    DataType == 'People' ~ 'People',
    DataType == 'Dogs On Leash' ~ 'Dogs On Leash',
    TRUE ~ 'Birds')) %>% 
  filter(DataType != "Birds") %>%
  ungroup() %>% 
  group_by(Year) %>% 
  summarize(peopletotal = sum(DataCount))

#People count by zone
people_counts_byzone <- shorebirds_fixed %>%
  group_by(DataType, Zone) %>% 
  mutate(DataType = case_when(
    DataType == 'People' ~ 'People',
    DataType == 'Dogs On Leash' ~ 'Dogs On Leash',
    TRUE ~ 'Birds')) %>% 
  filter(DataType != "Birds") %>%
  ungroup() %>% 
  group_by(Zone) %>% 
  summarize(peopletotal = sum(DataCount))

#bird Count by zone
bird_counts_byzone <- shorebirds_fixed %>%
  group_by(DataType, Zone) %>% 
  mutate(DataType = case_when(
    DataType == 'People' ~ 'People',
    DataType == 'Dogs On Leash' ~ 'Dogs On Leash',
    TRUE ~ 'Birds')) %>% 
  filter(DataType != "People",
         DataType != "Dogs On Leash") %>%
  ungroup() %>% 
  group_by(Zone) %>% 
  summarize(birdtotal = sum(DataCount))

#average count of birds and people by year
average_counts <- surveycounts %>%
  dplyr::right_join(bird_counts) %>%
  dplyr::right_join(people_counts) %>%
  group_by(Year, surveytotal) %>% 
  summarize(average_birds = (birdtotal/surveytotal),
            average_people = (peopletotal/surveytotal))

#Save average count of birds and people by year to plots folder
write_xlsx(average_counts, file.path(output_dir,"survey_count.xlsx"))

#exploratory analysis of survey number through years
plot <- ggplot(surveycounts, aes(x = Year, y = surveytotal)) +
  # Add points for individual data points
  geom_point(alpha = 0.6, size = 2, color = "steelblue") +
  # Add a smooth line connecting the points
  geom_line(alpha = 0.7, color = "steelblue") +
  # Add horizontal line for overall mean
  geom_hline(aes(yintercept = mean(surveytotal, na.rm = TRUE)), 
             color = "red", linetype = "dashed", size = 1) +
  # Add labels and title
  labs(
    title = "Survey Total by Year",
    subtitle = "Red dashed line shows overall mean survey total",
    x = "Year",
    y = "Survey Total",
    caption = "Data source: surveycount dataset"
  ) +
  # Apply a clean theme
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12, color = "gray60"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  ) +
  # Format x-axis to show years clearly
  scale_x_continuous(breaks = scales::pretty_breaks(n = 8))

# Display the plot
print(plot)

#Remove intermediary datasets
rm(surveycounts, bird_counts, people_counts, plot)
```

# Base Themes + Other Plot Details

```{r}
#Create base theme for all plots
base_theme_45 <- theme(text = element_text(size = 15),
                    # add more space between panels
                    panel.spacing = unit(1, 'lines'),
                    # no background to wrap panels
                    strip.background = element_blank(),
                    strip.text = element_text(size = 10, 
                                              hjust = 0),
                    # panel labels outside x axis labels
                    strip.placement = 'outside',
                    panel.grid = element_blank(),
                    # adjust x axis labels
                    axis.text.y = element_text(size = 10),
                    axis.text.x = element_text(size = 10, 
                                               angle = 45, 
                                               hjust = 1))

light_theme_45 <- theme_bw() + base_theme_45

# palettes for graphs
pal <- pnw_palette(name="Sunset2",n=3,type="discrete")
pal2 <- pnw_palette(name="Sunset2",n=2,type="discrete")
pal3 <- pnw_palette(name="Sailboat",n=6,type="discrete")
taropal <- c("#440154", "#fde725", "#228833", "#CCBB44", "#EE6677", "#AA3377", "#BBBBBB", "#99DDFF", "#44BB99")


# Usage in ggplot scale_fill_manual(values = pal9) 
scale_color_manual(values = taropal)

# graph tags
my_tag <- c("A) People", "B) Shorebirds")
my_tag2 <- c("A) Cormorant","B) Great Blue Heron","D) Osprey","E) Oystercatcher","F) Sandpiper") # uncommon taxa
my_tag3 <- c("A) Gull","B) Pelican","C) Tern") # common taxa

# taxa grouped under 'common' had an average of >5 obs. for at least one year while taxa grouped under 'uncommon' had an average of <5 obs. for all years.
```

# People + Shorebirds Data Analysis

```{r}
# Mean count per year of bird and people data
bird_and_visitors_data <- shorebirds_fixed %>%
  group_by(DataType, Year) %>% 
  mutate(DataType = case_when(
    DataType == 'People' ~ 'People',
    DataType == 'Dogs On Leash' ~ 'Dogs On Leash',
    TRUE ~ 'Shorebirds')) %>% 
  filter(DataType != "Dogs On Leash") %>% 
  summarize(yeartotal=sum(mean_per_survey_yearly)) %>% 
  ungroup() %>%
  # shorebird data not collected during these years
  mutate(yeartotal = if_else(Year == "1990" & DataType == "Shorebirds", 
                             NA, yeartotal)) 

# scatterplot for birds and visitors across years (NOT DIFFERENTIATING ZONES)
birdplot <- ggplot(bird_and_visitors_data, aes(x=Year, y=yeartotal, color=DataType)) + 
  geom_point() + 
  geom_line() +
  scale_color_manual(values = pal2) + 
  geom_smooth(method=lm) +
  ylab("Mean Observations per Survey") + 
  facet_grid(DataType~.) +
  theme(strip.text = element_blank(),
        axis.title.x = element_text(vjust = -1),
        axis.title.y = element_text(vjust = +3.5)) +
  light_theme_45 +
  theme(legend.position = "none")

birdplotfinal <- tag_facet(birdplot, tag_pool = my_tag, 
                           open = "", close = "", 
                           hjust = -0.2, size = 5)

birdplotfinal

# birds and visitors across years by zone
bird_and_visitors_data_byzone <- shorebirds_fixed %>%
  group_by(DataType, Year, Zone) %>% 
  mutate(DataType = case_when(
    DataType == 'People' ~ 'People',
    DataType == 'Dogs On Leash' ~ 'Dogs On Leash',
    TRUE ~ 'Shorebirds')) %>% 
  filter(DataType != "Dogs On Leash") %>% 
  summarize(yeartotal=sum(mean_per_survey_yearly)) %>% 
  ungroup() %>% 
  mutate(yeartotal = if_else(Year == "1990" & DataType == "Shorebirds", 
                             NA, yeartotal))

# Scatterplot of birds and people by zone
birdplot_byzone <- ggplot(bird_and_visitors_data_byzone, 
                          aes(x=Year, y=yeartotal, color=Zone)) + 
  geom_point() + 
  geom_line() +
  scale_color_manual(values = pal) + 
  geom_smooth(method=lm) +
  ylab("Mean Observations per Survey") + 
  scale_x_continuous(breaks = seq(from = min(bird_and_visitors_data_byzone$Year), 
                                  to = max(bird_and_visitors_data_byzone$Year), 
                                  by = 5)) +
  facet_grid(DataType~.) +
  theme(strip.text = element_blank(),
        axis.title.x = element_text(vjust = -1),
        axis.title.y = element_text(vjust = +2)) +
  light_theme_45

birdplotfinal_byzone <- tag_facet(birdplot_byzone, tag_pool = my_tag, 
                                  open = "", close = "", 
                                  hjust = -0.2, size = 4)
#Plot mean observations per survey
birdplotfinal_byzone

# Save the plot
ggsave(filename = file.path(output_dir,"BirdAndPeople.png"), 
       plot = birdplotfinal_byzone, 
       width = 6, 
       height = 5)

# Test significance of trends
trend_results <- data.frame()

# Get unique combinations
datatypes <- unique(bird_and_visitors_data_byzone$DataType)
zones <- unique(bird_and_visitors_data_byzone$Zone)

#for loop to calculate the summary statistics and store in trend results dataframe
for(dt in datatypes) {
  for(z in zones) {
    
    # Subset data for this combination
    subset_data <- bird_and_visitors_data_byzone[
      bird_and_visitors_data_byzone$DataType == dt & 
      bird_and_visitors_data_byzone$Zone == z, ]
    
    # Only proceed if we have enough data points
    if(nrow(subset_data) > 2) {
      
      # Fit linear model
      model <- lm(yeartotal ~ Year, data = subset_data)
      model_summary <- summary(model)
      
      # Extract statistics
      slope <- model_summary$coefficients["Year", "Estimate"]
      p_value <- model_summary$coefficients["Year", "Pr(>|t|)"]
      r_squared <- model_summary$r.squared
      
      # Store results
      trend_results <- rbind(trend_results, data.frame(
        DataType = dt,
        Zone = z,
        slope = slope,
        p_value = p_value,
        r_squared = r_squared,
        significant = p_value < 0.05,
        stringsAsFactors = FALSE
      ))
    }
  }
}

# View results
print(trend_results)

#Save the trend analysis
write_xlsx(trend_results, file.path(output_dir, "trend_results.xlsx"))

#Remove intermediary datasets
rm(bird_and_visitors_data, bird_and_visitors_data_byzone, birdplotfinal, birdplot, birdplot_byzone, model, model_summary, subset_data)
```

# Taxa of Interest Plot Generation

```{r}
# shorebirds of interest: Oystercatchers, Brown Pelicans, Cormorants, Gulls, Sandpiper, Grebe, Tern, Osprey, Heron. Lumping Gull, Tern, and Sandpiper sp. together.
shorebirds_ofinterest <- shorebirds_fixed %>%
  filter(DataType %in% c("Oystercatcher", "Great Blue Heron", "Grebe", "Osprey",
                         "Cormorant", "Brown Pelican", "Western Gull", 
                         "Unidentified Gull", "Ring-Billed Gull", "Mew Gull",
                         "Juvenile Gull", "Herring Gull", "Heerman's Gull",
                         "California Gull", "Bonaparte's Gull", "Western Sandpiper",
                         "Spotted Sandpiper", "American Oystercatcher", 
                         "Black Oystercatcher", "Pelican", "Tern", "Royal Tern",
                         "Forster's Tern", "Elegant Tern")) %>%
  mutate(DataType = case_when(
    str_detect(DataType, "Gull") ~ "Gull",
    str_detect(DataType, "Sandpiper") ~ "Sandpiper", 
    str_detect(DataType, "Oystercatcher") ~ "Oystercatcher",
    str_detect(DataType, "Tern") ~ "Tern",
    DataType == "Brown Pelican" ~ "Pelican",
    TRUE ~ DataType  # Keep original value for all others
  )) %>%
  group_by(DataType, Year, Zone) %>%
  summarize(yeartotal = sum(mean_per_survey_yearly), .groups = "drop") %>%
  mutate(yeartotal = if_else(Year == "1990", NA, yeartotal))

# separating by common vs uncommon taxa
shorebirds_ofinterest_high <- shorebirds_ofinterest %>% 
  filter(DataType %in% c("Gull","Tern","Pelican"))

shorebirds_ofinterest_low <- shorebirds_ofinterest %>% 
  filter(DataType %in% c("Osprey","Oystercatcher","Cormorant","Great Blue Heron","Sandpiper"))

# scatterplot for uncommon taxa across year by zone
shorebirds_ofinterest_scatterlow <- ggplot(shorebirds_ofinterest_low,   
                                           aes(x=Year, y=yeartotal, 
                                               color=Zone)) +  
  geom_line() + 
  geom_point() + 
  xlab("Year") + 
  ylab("Mean Observations per Survey") +
  ggh4x::facet_grid2(DataType ~ ., scales = "free_y", independent = "y") +
  scale_color_manual(values = pal) +
    scale_x_continuous(breaks = seq(1990,  # Start breaks at 1990
                                  max(shorebirds_ofinterest_low$Year), 
                                  by = 5)) +
  light_theme_45 +
  theme(strip.text = element_blank(),
        axis.title.x = element_text(vjust = -0.5),
        axis.title.y = element_text(vjust = +2.4),
        axis.text.y = element_text(size = 12))

# Create plot with correct tags (which are labels for each species in subplot)
shorebirds_ofinterest_scatterlow_final <- tag_facet(shorebirds_ofinterest_scatterlow, tag_pool = my_tag2, 
                                                    open = "", close = "",
                                                    hjust = -0.2, size = 4)

shorebirds_ofinterest_scatterlow_final

# Save the plot
ggsave(filename = file.path(output_dir,"shorebirds_other.png"), 
       plot = shorebirds_ofinterest_scatterlow_final, 
       width = 6, 
       height = 5)

# scatterplot for common taxa across year by zone
shorebirds_ofinterest_scatterhigh <- ggplot(shorebirds_ofinterest_high,
                                            aes(x=Year, y=yeartotal,      
                                                color=Zone)) +  
  geom_line() + 
  geom_point() + 
  xlab("Year") + 
  ylab("Mean Observations per Survey") + 
      scale_x_continuous(breaks = seq(1990,  # Start breaks at 1990
                                  max(shorebirds_ofinterest_high$Year), 
                                  by = 5)) +  # Shows every year including 2025
  facet_grid(DataType ~ .) + 
  scale_color_manual(values = pal) +
  light_theme_45

# Create plot with correct tags (which are labels for each species in subplot)
shorebirds_ofinterest_scatterhigh_final <- tag_facet(shorebirds_ofinterest_scatterhigh, tag_pool = my_tag3, 
                                                     open = "", close = "", 
                                                     hjust = -0.2, size = 4)

shorebirds_ofinterest_scatterhigh_final

# Save the plot
ggsave(filename = file.path(output_dir,"BirdsOfInterest.png"), 
       plot = shorebirds_ofinterest_scatterhigh_final, 
       width = 6, 
       height = 5)

# Remove intermediary datasets
rm(shorebirds_ofinterest_high, shorebirds_ofinterest_low, shorebirds_ofinterest_scatter, shorebirds_ofinterest_scatterlow, shorebirds_ofinterest_scatterhigh)
```

# Stacked Bar Chart

```{r}
# Shorebird groups
shorebirds_stack <- shorebirds_fixed %>%
  filter(!DataType %in% c("Dogs On Leash", "People")) %>%
  mutate(DataType = case_when(
    str_detect(DataType, "Gull") ~ "Gull",
    str_detect(DataType, "Sandpiper") ~ "Sandpiper", 
    str_detect(DataType, "Oystercatcher") ~ "Oystercatcher",
    str_detect(DataType, "Tern") ~ "Tern",
    DataType == "Brown Pelican" ~ "Pelican",
    DataType %in% c("Pelican", "Cormorant", "Great Blue Heron", 
                   "Osprey", "Grebe") ~ DataType,
    TRUE ~ "Others"
  )) %>%
  group_by(DataType, Year) %>%
  summarize(yeartotal = sum(mean_per_survey_yearly), .groups = "drop") %>%
  mutate(yeartotal = if_else(Year == "1990", NA, yeartotal)) %>%
  na.omit() %>%
  group_by(Year) %>%
  mutate(yearlymean_total = sum(yeartotal),
         proportion = yeartotal / yearlymean_total)

# Create the factor with levels (Grebe removed)
shorebirds_stack$DataType <- factor(shorebirds_stack$DataType,
                                    levels=c('Cormorant', 
                                             'Great Blue Heron', 
                                             'Gull', 
                                             'Osprey', 
                                             'Oystercatcher', 
                                             'Pelican', 
                                             'Sandpiper', 
                                             'Tern', 
                                             'Others'))

#Shorebird stacked plot
shorebirds_stackedplot <- ggplot(shorebirds_stack, 
                                 aes(x = Year, y = yeartotal, fill = DataType)) +
  geom_bar(stat = "identity") + 
  ylab("Mean Observations per Survey") + 
  labs(fill = "Taxa") +
  scale_fill_manual(values = taropal) +
  scale_x_continuous(breaks = seq(1990,  # Start breaks at 1990
                                  max(shorebirds_stack$Year), 
                                  by = 5)) +
  light_theme_45 + 
  theme(axis.title.y = element_text(vjust = +2.4))

shorebirds_stackedplot

# Save the plot
ggsave(filename = file.path(output_dir,"shorebird.png"), 
       plot = shorebirds_stackedplot, 
       width = 6, 
       height = 5)

# extra visual 
shorebirds_stackedprop <- ggplot(shorebirds_stack, aes(x=Year, y=proportion, fill=DataType)) +
  geom_bar(stat = "identity") + 
  ylab("Proportion") + 
  labs(fill = "Taxa") +
  scale_fill_manual(values = taropal) +
  scale_x_continuous(breaks = seq(min(shorebirds_stack$Year), 
                                  max(shorebirds_stack$Year), 
                                  by = 5)) +  # Shows every year including 2025
  light_theme_45 + 
  theme(axis.title.y = element_text(vjust = +2.4))

shorebirds_stackedprop

# Save the plot
ggsave(filename = file.path(output_dir,"shorebird_stacked_prop.png"), 
       plot = shorebirds_stackedprop, 
       width = 6, 
       height = 5)

rm(shorebirds_stack)
```
